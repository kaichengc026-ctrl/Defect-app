<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STOç¼ºé™·æª¢æ¸¬ç³»çµ± - å¯¦æ™‚ç›£æ§</title>
    <style>
        /* Reset */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html,body { height: 100%; }

        /* Palette */
        :root{
            --bg:#0b0f16;             /* page bg */
            --panel:#0f1724;          /* card bg */
            --muted:#8b95a6;          /* muted text */
            --accent1:#6b46c1;        /* purple */
            --accent2:#8b5cf6;        /* light purple */
            --accent2b:#b794f4;
            --success:#2e7d32;        /* green */
            --warning:#ff9800;        /* orange */
            --danger:#c62828;         /* red */
            --glass: rgba(255,255,255,0.03);
        }

        body{
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(180deg, #071023 0%, var(--bg) 50%);
            color: #e6eef8;
            min-height: 100vh;
            padding: 16px 20px 60px 20px;
        }

        /* Top banner */
        .top-banner{
            background: linear-gradient(90deg, var(--accent1), var(--accent2));
            border-radius: 12px;
            padding: 28px 36px;
            color: #fff;
            box-shadow: 0 8px 40px rgba(11,15,22,0.6);
        }
        .top-banner h1{ font-size: 1.6rem; font-weight:700; margin-bottom:6px; }
        .top-banner p{ opacity:0.9; font-size:0.95rem; }

        /* Application layout */
        .app{ max-width:1200px; margin: 20px auto; display:grid; grid-template-columns: 360px 1fr; gap:24px; align-items:start; }

        /* Sidebar */
        .sidebar{ display:flex; flex-direction:column; gap:18px; }
        .card{ background: linear-gradient(180deg, rgba(255,255,255,0.02), var(--panel)); border-radius:12px; padding:18px; box-shadow: 0 6px 30px rgba(2,6,23,0.6); }
        .card-title{ font-weight:700; color:#e6eef8; margin-bottom:12px; display:flex; align-items:center; justify-content:space-between; }

        /* Controls */
        .controls{ display:flex; flex-direction:column; gap:12px; }
        .btn{ padding:10px 14px; border-radius:10px; border:none; cursor:pointer; font-weight:700; color:#fff; box-shadow: 0 6px 18px rgba(2,6,23,0.5); }
        .btn-primary{ background: linear-gradient(90deg,var(--accent1),var(--accent2b)); }
        .btn-accent{ background: linear-gradient(90deg,#2b6cb0,#1976d2); }
        .btn-success{ background: linear-gradient(90deg,#2e7d32,#4caf50); }
        .btn-warning{ background: linear-gradient(90deg,#fb8c00,#ff9800); }
        .btn-muted{ background:#2b2f36; color:var(--muted); box-shadow:none; }

        .small-muted{ font-size:0.86rem; color:var(--muted); }
        .op-box{ background:var(--glass); padding:12px; border-radius:8px; color:var(--muted); min-height:64px; }

        /* Main area */
        .main{ display:flex; flex-direction:column; gap:18px; }

        /* Prediction panel */
        .prediction-box{ display:flex; gap:18px; align-items:center; justify-content:space-between; }
        .prediction-item{ flex:1; text-align:left; }
        .prediction-item label{ display:block; color:var(--muted); font-size:0.82rem; margin-bottom:6px; }
        .prediction-item .value{ font-size:1.6rem; font-weight:800; color:#fff; }
        .confidence-bar{ height:10px; background:#0b1220; border-radius:999px; overflow:hidden; }
        .confidence-fill{ height:100%; background:linear-gradient(90deg,var(--accent1),var(--accent2b)); transition:width 260ms ease; }

        .defect-indicator{ margin-top:10px; padding:10px 14px; border-radius:10px; font-weight:700; text-align:center; }
        .defect-normal{ background: rgba(46,125,50,0.12); color:var(--success); }
        .defect-detected{ background: rgba(198,30,30,0.08); color:var(--danger); }

        .timestamp{ color:var(--muted); font-size:0.85rem; text-align:right; margin-top:8px; }

        /* Image card */
        .img-wrap{ display:flex; align-items:center; justify-content:center; min-height:260px; background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02)); border-radius:10px; overflow:hidden; }
        #defect-image{ max-width:100%; max-height:380px; display:block; border-radius:8px; box-shadow: 0 10px 30px rgba(2,6,23,0.6); }

        /* Log list */
        #defect-log-list li{ padding:12px; border-radius:8px; margin-bottom:8px; background: rgba(255,255,255,0.02); display:flex; justify-content:space-between; align-items:center; }
        #defect-log-list li div{ color:var(--muted); }
        #defect-log-list button{ padding:6px 10px; border-radius:8px; border:none; cursor:pointer; }

        /* Queue and status */
        .queue-item-title{ display:flex; justify-content:space-between; color:var(--muted); font-weight:700; }
        .queue-bar{ height:18px; background:#0a0f16; border-radius:999px; overflow:hidden; }
        .queue-fill{ height:100%; background:linear-gradient(90deg,var(--accent1),var(--accent2)); display:flex; align-items:center; justify-content:center; color:#fff; font-weight:700; font-size:0.85rem; }

        .status-indicator{ display:flex; gap:10px; align-items:center; padding:8px 12px; background:rgba(255,255,255,0.02); border-radius:8px; color:var(--muted); }
        .status-dot{ width:10px; height:10px; border-radius:50%; background:#2e7d32; box-shadow:0 0 8px rgba(46,125,50,0.8); }

        /* Modal */
        .log-viewer-modal{ right:20px; top:100px; background:var(--panel); color:#e6eef8; }
        .log-viewer-meta{ color:var(--muted); }

        /* Responsive */
        @media (max-width: 900px){ .app{ grid-template-columns: 1fr; padding-top:12px; } .sidebar{ order:2; } .main{ order:1; } }
    </style>
</head>
<body>
    <div class="top-banner">
        <div style="max-width:1200px; margin:0 auto; display:flex; flex-direction:column; gap:6px;">
            <h1>STO å·¡é‚Šæª¢æ¸¬ AI ç³»çµ±</h1>
            <p></p>
        </div>
    </div>

    <div class="app">
        <aside class="sidebar">
            <div class="card">
                <div class="card-title">ç³»çµ±æ§åˆ¶</div>
                <div class="controls">
                    <button id="start-aoi" class="btn btn-primary">ğŸš€ å•Ÿå‹• AOI ç³»çµ±</button>
                    <button id="stop-aoi" class="btn btn-muted">â–  åœæ­¢ç³»çµ±</button>
                    <div style="display:flex; gap:8px;">
                        <button id="pause-btn" onclick="pauseSystem()" class="btn btn-warning" style="flex:1">â¸ï¸ æš«åœ</button>
                        <button id="resume-btn" onclick="resumeSystem()" class="btn btn-success" style="flex:1; display:none">â–¶ï¸ ç¹¼çºŒ</button>
                    </div>
                    <div style="display:flex; gap:8px;">
                        <button id="save-toggle" onclick="toggleSaveDefect()" class="btn btn-accent" >å­˜æª” ON</button>
                        <button id="camera-toggle" onclick="toggleCamera()" class="btn btn-muted">Camera ON</button>
                        <button id="demo-toggle" onclick="toggleDemoMode()" class="btn btn-muted">Demo OFF</button>
                    </div>
                </div>
                <div style="height:8px"></div>
                <div class="small-muted">æ“ä½œè¨Šæ¯</div>
                <div class="op-box" id="operation-log">ç›®å‰ç„¡</div>
            </div>



            <div class="card">
                <div class="card-title">ç¼ºé™·è¨˜éŒ„</div>
                <div id="log-container" style="max-height:320px; overflow:auto; margin-top:6px;">
                    <ul id="defect-log-list"></ul>
                </div>
                <div style="margin-top:10px; display:flex; gap:8px;">
                    <button id="pause-auto" onclick="pauseAuto()" class="btn btn-warning">â¸ï¸ æš«åœè‡ªå‹•</button>
                    <button id="resume-auto" onclick="resumeAuto()" class="btn btn-success" style="display:none">â–¶ï¸ ç¹¼çºŒè‡ªå‹•</button>
                </div>
            </div>
        </aside>

        <main class="main">
            <div class="card">
                <div class="card-title">ç•¶å‰æª¢æ¸¬ç‹€æ…‹</div>
                <div class="prediction-box">
                    <div class="prediction-item">
                        <label>åˆ†é¡</label>
                        <div class="value" id="prediction-class">å¾…æ©Ÿä¸­</div>
                    </div>
                    <div class="prediction-item">
                        <label>ä¿¡å¿ƒåº¦</label>
                        <div class="value" id="prediction-confidence">0%</div>
                        <div class="confidence-bar" style="margin-top:8px;">
                            <div class="confidence-fill" id="confidence-fill" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                <div id="defect-status" class="defect-indicator defect-normal">âœ… æ­£å¸¸</div>
                <div class="timestamp" id="prediction-timestamp">æœ€å¾Œæ›´æ–°: --:--:--</div>
            </div>

            <div class="card">
                <div class="card-title">æœ€æ–°ç¼ºé™·å½±åƒ</div>
                <div class="img-wrap">
                    <img id="defect-image" src="" alt="å°šç„¡ç¼ºé™·å½±åƒ" style="display:none;" />
                </div>
                <div class="timestamp" id="image-timestamp">æœ€å¾Œæ›´æ–°: --:--:--</div>
                <div style="margin-top:12px; display:flex; gap:10px; justify-content:flex-end;">
                    <button id="save-toggle-dup" onclick="toggleSaveDefect()" class="btn btn-accent">å­˜æª” ON</button>
                    <button id="open-log-viewer" onclick="openLogViewer(defectLog[0]||{})" class="btn btn-muted">æª¢è¦–å·²å­˜ç¼ºé™·</button>
                </div>
            </div>

            <div class="card">
                <div class="card-title">éšŠåˆ—èˆ‡ç³»çµ±</div>
                <div class="queue-item">
                    <div class="queue-item-title">
                        <span>å¹€éšŠåˆ— (Frame Queue)</span>
                        <span id="frame-queue-status">0 / 10000</span>
                    </div>
                    <div class="queue-bar" style="position:relative;">
                        <div class="queue-fill" id="frame-queue-fill" style="width: 0%">
                            <span id="frame-queue-percent">0%</span>
                        </div>
                        <div class="queue-label" id="frame-queue-label" style="position:absolute; left:50%; transform:translateX(-50%); top:0; height:100%; display:flex; align-items:center; justify-content:center; color:var(--muted); font-weight:700;">0 / 10000</div>
                    </div>
                </div>

                <div style="height:8px"></div>
                <div class="queue-item">
                    <div class="queue-item-title">
                        <span>ç¼ºé™·éšŠåˆ— (Defect Queue)</span>
                        <span id="defect-queue-status">0 / 500</span>
                    </div>
                    <div class="queue-bar" style="position:relative;">
                        <div class="queue-fill" id="defect-queue-fill" style="width: 0%">
                            <span id="defect-queue-percent">0%</span>
                        </div>
                        <div class="queue-label" id="defect-queue-label" style="position:absolute; left:50%; transform:translateX(-50%); top:0; height:100%; display:flex; align-items:center; justify-content:center; color:var(--muted); font-weight:700;">0 / 500</div>
                    </div>
                </div>

                <div style="height:10px"></div>
                <div class="status-indicator">
                    <div class="status-dot"></div>
                    <span>ğŸŸ¢ ç³»çµ±é‹è¡Œä¸­</span>
                </div>

                <div style="margin-top:10px; color:var(--muted); font-weight:600; display:flex; flex-direction:column; gap:6px;">
                    <div id="save-status-text">å­˜æª”ç‹€æ…‹ï¼š--</div>
                    <div id="camera-status-text">Camera ç‹€æ…‹ï¼š--</div>
                </div>

                <div style="display:flex; gap:8px; margin-top:14px;">
                    <button id="pause-btn-dup" onclick="pauseSystem()" class="btn btn-warning" style="flex:1">â¸ï¸ æš«åœ</button>
                    <button id="resume-btn-dup" onclick="resumeSystem()" class="btn btn-success" style="flex:1; display:none">â–¶ï¸ ç¹¼çºŒ</button>
                </div>
            </div>
        </main>
    </div>

    <!-- Non-blocking Log Viewer Modal -->
    <div id="log-viewer-modal" class="log-viewer-modal" role="dialog" aria-hidden="true">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <div style="font-weight:700">æª¢è¦–å·²å­˜ç¼ºé™·</div>
            <div>
                <button id="log-viewer-close" onclick="closeLogViewer()" style="padding:6px 10px; border:none; border-radius:6px; background:#9e9e9e; color:#fff; cursor:pointer;">é—œé–‰</button>
            </div>
        </div>
        <div id="log-viewer-content" style="display:flex; flex-direction:column; gap:8px;">
            <img id="log-viewer-image" src="" alt="å·²å­˜ç¼ºé™·" />
            <div id="log-viewer-meta" class="log-viewer-meta"></div>
            <div style="display:flex; gap:8px; justify-content:flex-end;">
                <button onclick="prevInViewer()" style="padding:6px 10px; border:none; border-radius:6px; background:#667eea; color:#fff; cursor:pointer;">Prev</button>
                <button onclick="nextInViewer()" style="padding:6px 10px; border:none; border-radius:6px; background:#667eea; color:#fff; cursor:pointer;">Next</button>
            </div>
        </div>
    </div>

    <script>
        // å®šæ™‚æ›´æ–°é æ¸¬çµæœ
        let blockPredictionUpdate = false; // global flag to prevent polling updates while showing defect
        function updatePrediction() {
            if (blockPredictionUpdate) return; // skip when showing defect image
            fetch('/api/prediction')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('prediction-class').textContent = data.class;
                    const confidence = (data.confidence * 100).toFixed(2);
                    document.getElementById('prediction-confidence').textContent = confidence + '%';
                    document.getElementById('confidence-fill').style.width = confidence + '%';
                    document.getElementById('prediction-timestamp').textContent = 
                        'æœ€å¾Œæ›´æ–°: ' + new Date().toLocaleTimeString('zh-TW');
                    
                    // æ›´æ–°ç¼ºé™·ç‹€æ…‹æŒ‡ç¤ºå™¨
                    const defectStatus = document.getElementById('defect-status');
                    if (data.class === 'æ­£å¸¸' || confidence < 30) {
                        defectStatus.className = 'defect-indicator defect-normal';
                        defectStatus.textContent = 'âœ… æ­£å¸¸';
                    } else {
                        defectStatus.className = 'defect-indicator defect-detected';
                        defectStatus.textContent = 'âš ï¸ æª¢æ¸¬åˆ°ç¼ºé™· - ' + data.class;
                    }
                })
                .catch(error => console.error('Error:', error));
        }

        // å®šæ™‚æ›´æ–°éšŠåˆ—ç‹€æ…‹
        function updateQueueStatus() {
            fetch('/api/queue-status')
                .then(response => response.json())
                .then(data => {
                    // Frame Queue
                    const framePercent = (data && data.frame_queue && typeof data.frame_queue.percentage === 'number') ? data.frame_queue.percentage.toFixed(1) : '0.0';
                    const frameFill = document.getElementById('frame-queue-fill');
                    if (frameFill) frameFill.style.width = framePercent + '%';
                    const framePercentEl = document.getElementById('frame-queue-percent');
                    if (framePercentEl) framePercentEl.textContent = framePercent + '%';
                    const frameStatus = document.getElementById('frame-queue-status');
                    if (frameStatus) frameStatus.textContent = (data && data.frame_queue) ? (data.frame_queue.current + ' / ' + data.frame_queue.max) : '';
                    const frameLabel = document.getElementById('frame-queue-label');
                    if (frameLabel) frameLabel.textContent = (data && data.frame_queue) ? (data.frame_queue.current + ' / ' + data.frame_queue.max) : '';

                    // Image Queue (optional)
                    if (data && data.image_queue) {
                        const imagePercent = data.image_queue.percentage.toFixed(1);
                        const imgFill = document.getElementById('image-queue-fill');
                        if (imgFill) imgFill.style.width = imagePercent + '%';
                        const imgPercentEl = document.getElementById('image-queue-percent');
                        if (imgPercentEl) imgPercentEl.textContent = imagePercent + '%';
                        const imgStatus = document.getElementById('image-queue-status');
                        if (imgStatus) imgStatus.textContent = data.image_queue.current + ' / ' + data.image_queue.max;
                        const imgLabel = document.getElementById('image-queue-label');
                        if (imgLabel) imgLabel.textContent = data.image_queue.current + ' / ' + data.image_queue.max;
                    }
                })
                .catch(error => console.error('Error:', error));
        }

        // Defect Queue UI æ›´æ–°ï¼ˆåŸºæ–¼ client-side defectQueueï¼‰
        function updateDefectQueueUI() {
            try {
                const nowCount = defectQueue.length;
                const maxCount = (typeof MAX_DEFECT_QUEUE === 'number') ? MAX_DEFECT_QUEUE : 500;
                const percent = Math.min(100, (nowCount / maxCount) * 100).toFixed(1);
                const fill = document.getElementById('defect-queue-fill');
                if (fill) fill.style.width = percent + '%';
                const pctEl = document.getElementById('defect-queue-percent');
                if (pctEl) pctEl.textContent = percent + '%';
                const statusEl = document.getElementById('defect-queue-status');
                if (statusEl) statusEl.textContent = `${nowCount} / ${maxCount}`;
                const labelEl = document.getElementById('defect-queue-label');
                if (labelEl) labelEl.textContent = `${nowCount} / ${maxCount}`;
            } catch (e) {
                console.error('updateDefectQueueUI error', e);
            }
        }

        // æ›´æ–°æš«åœç‹€æ…‹
        function updatePauseStatus() {
            fetch('/api/pause-status')
                .then(response => response.json())
                .then(data => {
                    const pauseBtn = document.getElementById('pause-btn');
                    const resumeBtn = document.getElementById('resume-btn');
                    const pauseBtnDup = document.getElementById('pause-btn-dup');
                    const resumeBtnDup = document.getElementById('resume-btn-dup');
                    const statusDot = document.querySelector('.status-indicator .status-dot');
                    const statusText = document.querySelector('.status-indicator span');
                    
                    if (data.paused) {
                        if (pauseBtn) pauseBtn.style.display = 'none';
                        if (resumeBtn) resumeBtn.style.display = 'block';
                        if (pauseBtnDup) pauseBtnDup.style.display = 'none';
                        if (resumeBtnDup) resumeBtnDup.style.display = 'block';
                        if (statusDot) statusDot.style.background = '#c62828';
                        if (statusText) statusText.textContent = 'ğŸ”´ ç³»çµ±æš«åœä¸­';
                    } else {
                        if (pauseBtn) pauseBtn.style.display = 'block';
                        if (resumeBtn) resumeBtn.style.display = 'none';
                        if (pauseBtnDup) pauseBtnDup.style.display = 'block';
                        if (resumeBtnDup) resumeBtnDup.style.display = 'none';
                        if (statusDot) statusDot.style.background = '#2e7d32';
                        if (statusText) statusText.textContent = 'ğŸŸ¢ ç³»çµ±é‹è¡Œä¸­';
                    }
                })
                .catch(error => console.error('Error:', error));
        }

        // æ›´æ–°æœ€æ–°ç¼ºé™·å½±åƒ
        function updateLastImage() {
            fetch('/api/last-image')
                .then(response => response.json())
                .then(data => {
                    const imgEl = document.getElementById('defect-image');
                    const tsEl = document.getElementById('image-timestamp');
                    if (data.image) {
                        imgEl.src = data.image;
                        imgEl.style.display = 'block';
                        tsEl.textContent = 'æœ€å¾Œæ›´æ–°: ' + (data.ts || new Date().toLocaleTimeString('zh-TW'));
                    } else {
                        imgEl.style.display = 'none';
                        tsEl.textContent = 'æœ€å¾Œæ›´æ–°: --:--:--';
                    }
                })
                .catch(error => console.error('Error:', error));
        }

        // å–å¾—å­˜æª”ç‹€æ…‹
        function fetchSaveDefectStatus() {
            fetch('/api/save-defect-status')
                .then(resp => resp.json())
                .then(data => {
                    const btn = document.getElementById('save-toggle');
                    const btnDup = document.getElementById('save-toggle-dup');
                    const enabled = data.save_defect;
                    setToggleAppearance(btn, enabled, 'å­˜æª” ON', 'å­˜æª” OFF');
                    setToggleAppearance(btnDup, enabled, 'å­˜æª” ON', 'å­˜æª” OFF');
                    const saveText = document.getElementById('save-status-text');
                    if (saveText) saveText.textContent = 'å­˜æª”ç‹€æ…‹ï¼š' + (enabled ? 'ON' : 'OFF');
                })
                .catch(err => console.error('Error:', err));
        }
        // Demo æ¨¡å¼ç‹€æ…‹ï¼ˆåƒ…æ›´æ–°æŒ‰éˆ•ï¼Œæ’­æ”¾é  SSE æ’ç¨‹ï¼‰
        let demoMode = false;
        function fetchDemoModeStatus() {
            fetch('/api/demo-mode-status')
                .then(resp => resp.json())
                .then(data => {
                    const enabled = !!data.demo_mode;
                    demoMode = enabled;
                    const btn = document.getElementById('demo-toggle');
                    setToggleAppearance(btn, enabled, 'Demo ON', 'Demo OFF');
                })
                .catch(err => console.error('Error:', err));
        }

        function toggleDemoMode() {
            const next = !demoMode;
            fetch('/api/demo-mode', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({enable: next})
            })
            .then(resp => resp.json())
            .then(data => {
                const enabled = !!data.demo_mode;
                demoMode = enabled;
                const btn = document.getElementById('demo-toggle');
                setToggleAppearance(btn, enabled, 'Demo ON', 'Demo OFF');
            })
            .catch(err => console.error('Error:', err));
        }

        // Helper to set consistent ON/OFF appearance for toggle buttons
        function setToggleAppearance(btn, enabled, onText, offText){
            if (!btn) return;
            // reset any known toggle classes
            btn.classList.remove('btn-muted','btn-accent','btn-primary','btn-success','btn-warning');
            if (enabled){
                btn.classList.add('btn-accent');
                btn.textContent = onText;
            } else {
                btn.classList.add('btn-muted');
                btn.textContent = offText;
            }
        }

        // åˆ‡æ›å­˜æª”ç‹€æ…‹
        function toggleSaveDefect() {
            const btn = document.getElementById('save-toggle');
            const btnDup = document.getElementById('save-toggle-dup');
            const next = btn && btn.textContent.includes('ON') ? false : true;
            fetch('/api/save-defect', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({enable: next})
            })
            .then(resp => resp.json())
            .then(data => {
                const enabled = data.save_defect;
                setToggleAppearance(btn, enabled, 'å­˜æª” ON', 'å­˜æª” OFF');
                setToggleAppearance(btnDup, enabled, 'å­˜æª” ON', 'å­˜æª” OFF');
                const saveText = document.getElementById('save-status-text');
                if (saveText) saveText.textContent = 'å­˜æª”ç‹€æ…‹ï¼š' + (enabled ? 'ON' : 'OFF');
            })
            .catch(err => console.error('Error:', err));
        }

        // å–å¾—ç›¸æ©Ÿç‹€æ…‹
        function fetchCameraStatus() {
            fetch('/api/camera-status')
                .then(resp => resp.json())
                .then(data => {
                    const btn = document.getElementById('camera-toggle');
                    const on = !!(data && data.on);
                    setToggleAppearance(btn, on, 'Camera ON', 'Camera OFF');
                    const camText = document.getElementById('camera-status-text');
                    if (camText) camText.textContent = 'Camera ç‹€æ…‹ï¼š' + (on ? 'ON' : 'OFF');
                })
                .catch(err => console.error('Error:', err));
        }

        // åˆ‡æ›ç›¸æ©Ÿé–‹é—œ
        function toggleCamera() {
            const btn = document.getElementById('camera-toggle');
            const next = btn && btn.textContent.includes('ON') ? false : true;
            fetch('/api/camera', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({enable: next})
            })
            .then(resp => resp.json())
            .then(data => {
                const on = !!data.on;
                setToggleAppearance(btn, on, 'Camera ON', 'Camera OFF');
                const camText = document.getElementById('camera-status-text');
                if (camText) camText.textContent = 'Camera ç‹€æ…‹ï¼š' + (on ? 'ON' : 'OFF');
            })
            .catch(err => console.error('Error:', err));
        }

        // æš«åœç³»çµ±
        function pauseSystem() {
            fetch('/api/pause', {method: 'POST'})
                .then(response => response.json())
                .then(data => {
                    console.log(data.message);
                    updatePauseStatus();
                })
                .catch(error => console.error('Error:', error));
        }

        // æ¢å¾©ç³»çµ±
        function resumeSystem() {
            fetch('/api/resume', {method: 'POST'})
                .then(response => response.json())
                .then(data => {
                    console.log(data.message);
                    updatePauseStatus();
                })
                .catch(error => console.error('Error:', error));
        }

        // åˆå§‹åŒ–ä¸¦è¨­ç½®å®šæ™‚æ›´æ–°ï¼ˆæ¯ 500msï¼‰
        updatePrediction();
        updateQueueStatus();
        updateDefectQueueUI();
        updatePauseStatus();
        updateLastImage(); // é¦–æ¬¡è¼‰å…¥ä¿ç•™ä¸€æ¬¡
        fetchSaveDefectStatus();
        fetchCameraStatus();
        fetchDemoModeStatus();
        setInterval(updatePrediction, 250);
        setInterval(updateQueueStatus, 250);
        setInterval(updateDefectQueueUI, 250);
        setInterval(updatePauseStatus, 1000);
        setInterval(fetchSaveDefectStatus, 2000);
        setInterval(fetchCameraStatus, 2000);
        setInterval(fetchDemoModeStatus, 2000);

        // ----- SSE æ¨é€èˆ‡ç¼ºé™·æ’­æ”¾ / æ—¥èªŒæ©Ÿåˆ¶ -----
        const defectQueue = [];
        // çµ±ä¸€é¡¯ç¤ºé–“éš”ï¼ˆæ¯«ç§’ï¼‰
        const DISPLAY_MS = 250;
        // å®¢æˆ¶ç«¯æ’­æ”¾éšŠåˆ—ä¸Šé™ï¼ˆè¶…éæœƒä¸Ÿæ£„æœ€èˆŠçš„äº‹ä»¶ï¼‰
        const MAX_DEFECT_QUEUE = 500;
        let defectLog = [];
        let autoPlay = true;
        let isShowing = false;
        let currentDisplayId = null;
        // viewingManual prevents autoplay from resuming until user resumes
        let viewingManual = false;

        function renderLog() {
            const list = document.getElementById('defect-log-list');
            list.innerHTML = '';
            defectLog.forEach(entry => {
                const li = document.createElement('li');
                li.style.padding = '8px';
                li.style.borderBottom = '1px solid #eee';
                li.style.display = 'flex';
                li.style.justifyContent = 'space-between';
                li.style.alignItems = 'center';

                const constClass = entry['class'] || '';
                const constConf = (entry['confidence'] !== null && entry['confidence'] !== undefined) ? (Number(entry['confidence'])*100).toFixed(2) + '%' : '';
                const constMeta = (constClass || constConf) ? (`${constClass} ${constConf}`.trim()) : '';
                const left = document.createElement('div');
                left.innerHTML = `<div style="font-weight:700">#${entry.id} ${entry.filename || ''}</div><div style="font-size:0.9em;color:#666">${entry.ts} ${constMeta ? 'â€¢ ' + constMeta : ''}</div>`;

                const right = document.createElement('div');
                const savedSpan = document.createElement('span');
                savedSpan.textContent = entry.saved ? 'å·²å­˜æª”' : 'æœªå­˜æª”';
                savedSpan.style.marginRight = '8px';
                savedSpan.style.color = entry.saved ? '#2e7d32' : '#c62828';

                const viewBtn = document.createElement('button');
                viewBtn.textContent = 'æª¢è¦–';
                viewBtn.style.padding = '6px 10px';
                viewBtn.style.border = 'none';
                viewBtn.style.borderRadius = '6px';
                viewBtn.style.cursor = entry.saved ? 'pointer' : 'not-allowed';
                viewBtn.style.background = entry.saved ? '#1976d2' : '#e0e0e0';
                viewBtn.style.color = entry.saved ? '#fff' : '#888';
                viewBtn.onclick = () => {
                    if (!entry.saved) return alert('æ­¤åœ–ç‰‡å°šæœªå­˜æª”ï¼Œç„¡æ³•æª¢è¦–');
                    // Open a non-blocking viewer (does not pause autoplay or affect detection)
                    openLogViewer(entry);
                };

                right.appendChild(savedSpan);
                right.appendChild(viewBtn);

                li.appendChild(left);
                li.appendChild(right);
                list.appendChild(li);
            });
        }

        // Non-blocking log viewer functions (do not alter autoplay or detection)
        let currentViewerIndex = -1;
        function openLogViewer(entry) {
            try {
                const modal = document.getElementById('log-viewer-modal');
                const img = document.getElementById('log-viewer-image');
                const meta = document.getElementById('log-viewer-meta');
                if (!entry || !entry.filename) return alert('ç„¡å¯æª¢è¦–çš„æª”æ¡ˆ');
                img.src = '/api/defect-image/' + encodeURIComponent(entry.filename);
                meta.textContent = `#${entry.id} ${entry.filename || ''} â€¢ ${entry.ts} â€¢ ${entry['class'] || ''} ${entry['confidence']? (Number(entry['confidence'])*100).toFixed(2)+'%':''}`;
                modal.style.display = 'block';
                modal.setAttribute('aria-hidden','false');
                // update index for prev/next
                currentViewerIndex = defectLog.findIndex(e => e.id === entry.id);
            } catch (e) {
                console.error('openLogViewer failed', e);
            }
        }
        function closeLogViewer() {
            const modal = document.getElementById('log-viewer-modal');
            modal.style.display = 'none';
            modal.setAttribute('aria-hidden','true');
            currentViewerIndex = -1;
        }
        function prevInViewer() {
            if (currentViewerIndex <= 0) return;
            currentViewerIndex -= 1;
            const entry = defectLog[currentViewerIndex];
            openLogViewer(entry);
        }
        function nextInViewer() {
            if (currentViewerIndex < 0 || currentViewerIndex >= defectLog.length-1) return;
            currentViewerIndex += 1;
            const entry = defectLog[currentViewerIndex];
            openLogViewer(entry);
        }

        async function fetchInitialLogs() {
            try {
                const resp = await fetch('/api/defect-logs');
                const data = await resp.json();
                defectLog = data.logs || [];
                renderLog();
            } catch (e) {
                console.error('Failed to fetch logs', e);
            }
        }

        function startAutoShow() {
            if (isShowing || !autoPlay) return;
            isShowing = true;
            showNext();
        }

        function pauseAuto() {
            autoPlay = false;
            document.getElementById('pause-auto').style.display = 'none';
            document.getElementById('resume-auto').style.display = 'inline-block';
        }

        function resumeAuto() {
            autoPlay = true;
            viewingManual = false;
            blockPredictionUpdate = false;
            document.getElementById('resume-auto').style.display = 'none';
            document.getElementById('pause-auto').style.display = 'inline-block';
            startAutoShow();
        }

        function toggleLog() {
            const c = document.getElementById('log-container');
            c.style.display = c.style.display === 'none' ? 'block' : 'none';
        }

        function displaySavedImage(filename, ts, className, confidence) {
            const imgEl = document.getElementById('defect-image');
            const tsEl = document.getElementById('image-timestamp');
            imgEl.src = '/api/defect-image/' + encodeURIComponent(filename);
            imgEl.style.display = 'block';
            tsEl.textContent = 'æœ€å¾Œæ›´æ–°: ' + (ts || new Date().toLocaleTimeString('zh-TW'));
            // update prediction UI to match image
            if (className !== undefined) {
                const confPct = (confidence !== null && confidence !== undefined) ? (Number(confidence)*100).toFixed(2) : '0.00';
                document.getElementById('prediction-class').textContent = className;
                document.getElementById('prediction-confidence').textContent = confPct + '%';
                document.getElementById('confidence-fill').style.width = confPct + '%';
                // update defect status indicator
                const defectStatus = document.getElementById('defect-status');
                if (className === 'æ­£å¸¸' || Number(confPct) < 30) {
                    defectStatus.className = 'defect-indicator defect-normal';
                    defectStatus.textContent = 'âœ… æ­£å¸¸';
                } else {
                    defectStatus.className = 'defect-indicator defect-detected';
                    defectStatus.textContent = 'âš ï¸ æª¢æ¸¬åˆ°ç¼ºé™· - ' + className;
                }
            } else {
                // if class not provided, try to find in log
                const found = defectLog.find(e => e.filename === filename);
                if (found) {
                    const confPct = (found.confidence !== null && found.confidence !== undefined) ? (Number(found.confidence)*100).toFixed(2) : '0.00';
                    document.getElementById('prediction-class').textContent = found['class'] || 'å¾…æ©Ÿä¸­';
                    document.getElementById('prediction-confidence').textContent = confPct + '%';
                    document.getElementById('confidence-fill').style.width = confPct + '%';
                    const defectStatus = document.getElementById('defect-status');
                    if ((found['class'] === 'æ­£å¸¸') || Number(confPct) < 30) {
                        defectStatus.className = 'defect-indicator defect-normal';
                        defectStatus.textContent = 'âœ… æ­£å¸¸';
                    } else {
                        defectStatus.className = 'defect-indicator defect-detected';
                        defectStatus.textContent = 'âš ï¸ æª¢æ¸¬åˆ°ç¼ºé™· - ' + found['class'];
                    }
                }
            }
        }

        function displayImageItem(item) {
            const imgEl = document.getElementById('defect-image');
            const tsEl = document.getElementById('image-timestamp');
            if (item.b64) imgEl.src = item.b64;
            else if (item.saved && item.filename) imgEl.src = '/api/defect-image/' + encodeURIComponent(item.filename);
            imgEl.style.display = 'block';
            tsEl.textContent = 'æœ€å¾Œæ›´æ–°: ' + (item.ts || new Date().toLocaleTimeString('zh-TW'));
            currentDisplayId = item.id;
            // set prediction UI to match this defect image and block polling temporarily
            if (item['class'] !== undefined) {
                const confPct = (item['confidence'] !== null && item['confidence'] !== undefined) ? (Number(item['confidence'])*100).toFixed(2) : '0.00';
                document.getElementById('prediction-class').textContent = item['class'] || 'å¾…æ©Ÿä¸­';
                document.getElementById('prediction-confidence').textContent = confPct + '%';
                document.getElementById('confidence-fill').style.width = confPct + '%';
                // update defect status indicator
                const defectStatus = document.getElementById('defect-status');
                if (item['class'] === 'æ­£å¸¸' || Number(confPct) < 30) {
                    defectStatus.className = 'defect-indicator defect-normal';
                    defectStatus.textContent = 'âœ… æ­£å¸¸';
                } else {
                    defectStatus.className = 'defect-indicator defect-detected';
                    defectStatus.textContent = 'âš ï¸ æª¢æ¸¬åˆ°ç¼ºé™· - ' + item['class'];
                }
            }
            blockPredictionUpdate = true;
            // clear block after DISPLAY_MS to allow regular updates
            setTimeout(() => { blockPredictionUpdate = false; }, DISPLAY_MS);
        }

        async function showNext() {
            if (!autoPlay) { isShowing = false; return; }
            if (defectQueue.length === 0) { isShowing = false; return; }
            const item = defectQueue.shift();
            updateDefectQueueUI();

            // If item already contains base64 (e.g., demo/OK events), display directly
            if (item.b64) {
                displayImageItem(item);
                setTimeout(() => { showNext(); }, DISPLAY_MS);
                return;
            }

            // If saved file exists, display directly from server
            if (item.saved && item.filename) {
                displayImageItem(item);
                setTimeout(() => { showNext(); }, DISPLAY_MS);
                return;
            }

            // Try to fetch base64 on-demand for unsaved defects
            try {
                // Only attempt fetch if item has a valid id
                if (!item.id && item.id !== 0) throw new Error('no id');
                const resp = await fetch('/api/defect-b64/' + encodeURIComponent(item.id));
                if (!resp.ok) throw new Error('no b64');
                const body = await resp.json();
                if (!body.b64) throw new Error('no b64');
                item.b64 = body.b64;
                displayImageItem(item);
                setTimeout(() => { showNext(); }, DISPLAY_MS);
                return;
            } catch (e) {
                // Could not fetch image data: show timestamp only and continue
                const imgEl = document.getElementById('defect-image');
                imgEl.style.display = 'none';
                const tsEl = document.getElementById('image-timestamp');
                tsEl.textContent = 'æœ€å¾Œæ›´æ–°: ' + (item.ts || new Date().toLocaleTimeString('zh-TW')) + ' (å½±åƒè¼‰å…¥å¤±æ•—)';
                // still update prediction UI from metadata
                if (item['class'] !== undefined) {
                    const confPct = (item['confidence'] !== null && item['confidence'] !== undefined) ? (Number(item['confidence'])*100).toFixed(2) : '0.00';
                    document.getElementById('prediction-class').textContent = item['class'] || 'å¾…æ©Ÿä¸­';
                    document.getElementById('prediction-confidence').textContent = confPct + '%';
                    document.getElementById('confidence-fill').style.width = confPct + '%';
                }
                console.warn('Failed to load b64 for id', item.id);
                // skip this item immediately and continue to next to drain backlog faster
                setTimeout(() => { showNext(); }, 0);
                return;
            }
        }

        // SSE æ¥æ”¶
        const defectSource = new EventSource('/api/defect-stream');
        defectSource.addEventListener('defect', e => {
            try {
                const data = JSON.parse(e.data);
                // push to play queue and cap size
                defectQueue.push(data);
                while (defectQueue.length > MAX_DEFECT_QUEUE) {
                    defectQueue.shift();
                }
                updateDefectQueueUI();
                // If this is a demo event, do not add it to the persistent defectLog (it should not appear in the list)
                if (!data.demo) {
                    defectLog.unshift({id: data.id, ts: data.ts, saved: data.saved, filename: data.filename, 'class': data['class'], 'confidence': data['confidence']});
                }
                // Immediately align prediction UI to incoming item
                if (data && (data['class'] !== undefined)) {
                    const confPct = (data['confidence'] !== null && data['confidence'] !== undefined) ? (Number(data['confidence'])*100).toFixed(2) : '0.00';
                    document.getElementById('prediction-class').textContent = data['class'] || 'å¾…æ©Ÿä¸­';
                    document.getElementById('prediction-confidence').textContent = confPct + '%';
                    document.getElementById('confidence-fill').style.width = confPct + '%';
                    const defectStatus = document.getElementById('defect-status');
                    if (data['class'] === 'æ­£å¸¸' || Number(confPct) < 30) {
                        defectStatus.className = 'defect-indicator defect-normal';
                        defectStatus.textContent = 'âœ… æ­£å¸¸';
                    } else {
                        defectStatus.className = 'defect-indicator defect-detected';
                        defectStatus.textContent = 'âš ï¸ æª¢æ¸¬åˆ°ç¼ºé™· - ' + data['class'];
                    }
                }
                // keep log size reasonable (only counts non-demo items)
                if (defectLog.length > 1000) defectLog.pop();
                renderLog();
                startAutoShow();
            } catch (err) {
                console.error('Failed to parse defect SSE data', err);
            }
        });
        defectSource.addEventListener('error', e => {
            console.warn('SSE connection error', e);
        });

        // initialize logs
        fetchInitialLogs();
    </script>
</body>
</html>
